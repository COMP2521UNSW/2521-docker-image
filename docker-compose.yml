# docker-compose.yml -- configuration for the 2521 docker image's system
#
# This describes how to run the docker image, so that students get a consistent
# and reliable environment.
#
# Author: Maddy Guthridge
services:
  cs2521:
    build:
      context: .
      # Link SSH agent
      ssh: ["default"]
    hostname: cs2521
    # https://stackoverflow.com/a/39150040/6335363
    stdin_open: true # docker run -i
    tty: true        # docker run -t
    # Only allow 500k files per process (https://stackoverflow.com/a/31474407/6335363)
    # By default, Docker has a limit of around 1 billion files, which is
    # problematic as upon detecting errors, LLVM's sanitizers iterate through
    # all available file descriptors to close everything before exiting,
    # causing the process to hang for a few minutes.
    # See issue: https://github.com/llvm/llvm-project/issues/59112
    ulimits:
      nofile: 524288
    # Add the "ptrace" capability to allow for better debugging
    # https://stackoverflow.com/a/49735927/6335363
    cap_add:
      - "SYS_PTRACE"
    volumes:
      # Work directory, where work is completed
      - "./work:/home/ubuntu/work:rw"
      # SSH config -- this must be mounted directly, since otherwise it'll just
      # be a symlink to the external user's SSH config, which won't be
      # accessible to the container.
      - "./config/ssh:/home/ubuntu/.ssh:rw"
      # .2521-config, which symlinks to various files that should be preserved
      # between rebuilds.
      - "./config:/home/ubuntu/.2521-config:rw"
